<IfDefine BOTCHECK_DIR>
    RewriteEngine On

    RewriteMap lookup prg:${BOTCHECK_DIR}/lookup

    # The botcheck page, served with 202 status code when direct access is denied
    Alias /botcheck.html ${BOTCHECK_DIR}/botcheck.html
    ErrorDocument 202 /botcheck.html
    <Location /botcheck.html>
        Require all granted
    </Location>
    RewriteCond %{REQUEST_URI} ^/botcheck\.html$
    RewriteRule .* - [L]

    # Skip access control for excluded paths
    RewriteCond %{REQUEST_URI} ^/(status|robots\.txt|favicon\.ico|\.well-known/)$ [OR]
    RewriteCond %{REQUEST_URI} ^/feed
    RewriteRule .* - [E=BOTCHECK:OK]

    # Set environment variable for allow-listed IPs
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteCond ${lookup:addresses.net.list %{REMOTE_ADDR}|NOT_FOUND} !=NOT_FOUND
    RewriteRule .* - [E=BOTCHECK:OK]

    # Set environment variable for allow-listed User-Agents
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteCond ${lookup:useragents.ri.list %{HTTP_USER_AGENT}|NOT_FOUND} !=NOT_FOUND
    RewriteRule .* - [E=BOTCHECK:OK]

    # Set environment variable for valid cookie
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteCond %{HTTP_COOKIE} botcheck
    RewriteRule .* - [E=BOTCHECK:OK]

    # Return 202 status and the botcheck page if none of the conditions are met
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteRule .* - [L,R=202]
</IfDefine>
