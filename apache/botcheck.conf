<IfDefine BOTCHECK_DIR>
    RewriteEngine On
    RewriteMap whitelist_ips prg:${BOTCHECK_DIR}/ips
    RewriteMap whitelist_uas txt:${BOTCHECK_DIR}/useragents

    # Custom error document for 202 status
    ErrorDocument 202 ${BOTCHECK_DIR}/botcheck.html

    # Skip access control for excluded paths
    RewriteCond %{REQUEST_URI} ^/(api/health|status|robots\.txt|favicon\.ico|\.well-known/.*|admin/login|consent\.html)$
    RewriteRule .* - [E=WHITELISTED:1]

    # Set environment variable for whitelisted IPs
    RewriteCond %{REMOTE_ADDR} ^(.+)$
    RewriteCond ${whitelist_ips:%1|NOT_FOUND} !=NOT_FOUND
    RewriteRule .* - [E=WHITELISTED:1]

    # Set environment variable for whitelisted User-Agents
    RewriteCond %{HTTP_USER_AGENT} ^(.+)$
    RewriteCond ${whitelist_uas:%1|NOT_FOUND} !=NOT_FOUND
    RewriteRule .* - [E=WHITELISTED:1]

    # Set environment variable for valid cookie
    RewriteCond %{HTTP_COOKIE} botcheck
    RewriteRule .* - [E=WHITELISTED:1]

    # Return 202 status if none of the conditions are met
    RewriteCond %{ENV:WHITELISTED} !^1$
    RewriteRule .* - [R=202,L]
</IfDefine>
