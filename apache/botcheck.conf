<IfDefine BOTCHECK_DIR>
    RewriteEngine On

    RewriteMap lookup prg:${BOTCHECK_DIR}/lookup

    # Handle non-JavaScript confirmation POST (preserve query string)
    RewriteCond %{REQUEST_METHOD} POST
    RewriteCond %{HTTP_REFERER} ^https?://[^/]+(/[^?]*)(?:\\?(.*))?$ [NC]
    RewriteCond %2 !^$
    RewriteRule ^/botcheck-confirm$ %1?%2 [L,R=303,NE,E=BOTCHECK_CONFIRM:1]

    # Handle POST without query in Referer
    RewriteCond %{REQUEST_METHOD} POST
    RewriteCond %{HTTP_REFERER} ^https?://[^/]+(/[^?]*)(?:\\?(.*))?$ [NC]
    RewriteRule ^/botcheck-confirm$ %1 [L,R=303,NE,E=BOTCHECK_CONFIRM:1]

    # Fallback redirect when no Referer
    RewriteCond %{REQUEST_METHOD} POST
    RewriteRule ^/botcheck-confirm$ / [L,R=303,E=BOTCHECK_CONFIRM:1]

    # Set cookie for confirmed users
    Header always set Set-Cookie "botcheck=1; Max-Age=2592000; Path=/; SameSite=Strict" env=BOTCHECK_CONFIRM

    # The botcheck page, served with 402 status code when direct access is denied
    Alias /botcheck ${BOTCHECK_DIR}/botcheck.html
    ErrorDocument 402 /botcheck
    <Location /botcheck>
        Require all granted
    </Location>
    RewriteCond %{REQUEST_URI} ^/botcheck$
    RewriteRule .* - [L]

    # Skip botcheck during error handling subrequests
    RewriteCond %{ENV:REDIRECT_STATUS} !^$
    RewriteRule .* - [E=BOTCHECK:OK]

    # Skip access control for excluded paths
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteCond %{REQUEST_URI} ^/(status|robots\.txt|favicon\.ico|\.well-known/)$ [OR]
    RewriteCond %{REQUEST_URI} ^/feed
    RewriteRule .* - [E=BOTCHECK:OK]

    # Set environment variable for allow-listed IPs
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteCond ${lookup:addresses.net.list;%{REMOTE_ADDR}|NOT_FOUND} !=NOT_FOUND
    RewriteRule .* - [E=BOTCHECK:OK]

    # Set environment variable for allow-listed User-Agents
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteCond ${lookup:useragents.ri.list;%{HTTP_USER_AGENT}|NOT_FOUND} !=NOT_FOUND
    RewriteRule .* - [E=BOTCHECK:OK]

    # Set environment variable for valid cookie
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteCond %{HTTP_COOKIE} botcheck
    RewriteRule .* - [E=BOTCHECK:OK]

    # Return 402 status and the botcheck page if none of the conditions are met
    RewriteCond %{ENV:BOTCHECK} !^OK$
    RewriteRule .* - [L,R=402]
</IfDefine>
